// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT & AUTHENTICATION
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // Used in subdomains or URLs
  status    TenantStatus @default(ACTIVE)
  
  // Billing & limits
  plan      String   @default("free") // free, starter, pro, enterprise
  messagesPerMinute Int @default(60)
  maxPhoneNumbers   Int @default(1)
  maxAgents        Int @default(3)
  
  // Usage tracking
  messagesSentThisMonth Int @default(0)
  billingPeriodStart    DateTime @default(now())
  billingPeriodEnd      DateTime?
  
  // Customization
  themeColor    String?  @default("#6366f1") // Primary brand color
  themeName     String?  @default("default")
  logoUrl       String?
  webhookUrl    String?
  webhookVerifyToken String?
  webhookVerifiedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  adminUsers    AdminUser[]
  wabaCredentials WABACredential[]
  conversations Conversation[]
  messages      Message[]
  templates     Template[]
  rawWebhookEvents RawWebhookEvent[]
  agents        Agent[]
  contacts      Contact[]
  campaigns     Campaign[]
  cannedResponses CannedResponse[]
  flows         Flow[]
  
  @@index([slug])
  @@index([status])
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String
  role      UserRole @default(TENANT_ADMIN)
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  lastLoginAt DateTime?
  isActive    Boolean  @default(true)
  
  agents      Agent[] // Agents linked to this admin user
  sessions    Session[] // Active sessions
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@index([email])
}

enum UserRole {
  SYSTEM_ADMIN  // Platform super admin
  TENANT_ADMIN  // Tenant owner/admin
  AGENT         // Customer service agent
  BILLING_ADMIN // Billing & subscription manager
}

model Agent {
  id       String @id @default(cuid())
  name     String
  email    String
  password String? // bcrypt hashed password for agent login
  isOnline Boolean @default(false)
  
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  adminUserId String? // Link to AdminUser if agent has login
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: SetNull)
  
  // Team collaboration features
  status             AgentStatus @default(OFFLINE)
  maxConcurrentChats Int @default(10)
  skills             String[] @default([])
  
  // Granular permissions
  permissions        AgentPermission[] @default([])
  
  assignedConversations Conversation[]
  sessions           Session[] // Active sessions
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@unique([tenantId, email])
}

enum AgentPermission {
  // Conversation Management
  VIEW_CONVERSATIONS
  SEND_MESSAGES
  DELETE_MESSAGES
  ASSIGN_CONVERSATIONS
  CLOSE_CONVERSATIONS
  
  // Contact Management
  VIEW_CONTACTS
  CREATE_CONTACTS
  EDIT_CONTACTS
  DELETE_CONTACTS
  EXPORT_CONTACTS
  
  // Campaign Management
  VIEW_CAMPAIGNS
  CREATE_CAMPAIGNS
  EDIT_CAMPAIGNS
  DELETE_CAMPAIGNS
  EXECUTE_CAMPAIGNS
  
  // Template Management
  VIEW_TEMPLATES
  CREATE_TEMPLATES
  EDIT_TEMPLATES
  DELETE_TEMPLATES
  
  // Canned Responses
  VIEW_CANNED_RESPONSES
  CREATE_CANNED_RESPONSES
  EDIT_CANNED_RESPONSES
  DELETE_CANNED_RESPONSES
  
  // Analytics
  VIEW_ANALYTICS
  EXPORT_ANALYTICS
  
  // Settings
  VIEW_SETTINGS
  EDIT_SETTINGS
  
  // Agent Management (for senior agents)
  VIEW_AGENTS
  MANAGE_AGENTS

  // Flow Builder
  VIEW_FLOWS
  CREATE_FLOWS
  EDIT_FLOWS
  DELETE_FLOWS
}

enum AgentStatus {
  ONLINE
  AWAY
  BUSY
  OFFLINE
}

// ============================================
// WHATSAPP BUSINESS API CREDENTIALS
// ============================================

model WABACredential {
  id              String  @id @default(cuid())
  tenantId        String
  tenant          Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  phoneNumberId   String  @unique // Meta's phone number ID
  phoneNumber     String  // Actual WhatsApp number (e.g., +1234567890)
  displayName     String? // Business display name
  
  // Encrypted access token (use KMS or app-level encryption)
  accessToken     String  // Store encrypted in production
  
  businessAccountId String? // WABA ID
  
  isValid         Boolean @default(true)
  lastValidatedAt DateTime @default(now())
  invalidReason   String? // Token expired, revoked, etc.
  
  // Quality & limits
  qualityRating   String? // GREEN, YELLOW, RED
  messagingLimit  String? // TIER_1K, TIER_10K, etc.
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([phoneNumberId])
}

// ============================================
// RAW WEBHOOK EVENTS (Persist-First Pattern)
// ============================================

model RawWebhookEvent {
  id        String   @id @default(cuid())
  
  // Resolved from phoneNumberId in payload
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  
  phoneNumberId String? // From Meta webhook payload
  
  // Raw payload as JSON
  payload   Json
  
  // Processing status
  status    WebhookStatus @default(PENDING)
  processedAt DateTime?
  errorMessage String?
  retryCount   Int @default(0)
  
  createdAt DateTime @default(now())
  
  @@index([tenantId])
  @@index([phoneNumberId])
  @@index([status])
  @@index([createdAt])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Conversation {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Contact info
  contactPhone  String   // Customer's WhatsApp number
  contactName   String?
  
  // Contact relation
  contactId     String?
  contact       Contact? @relation("ContactConversations", fields: [contactId], references: [id], onDelete: SetNull)
  
  // Assignment
  assignedAgentId String?
  assignedAgent   Agent? @relation(fields: [assignedAgentId], references: [id], onDelete: SetNull)
  
  // Campaign relation
  campaignId    String?
  campaign      Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  // Status
  status        ConversationStatus @default(OPEN)
  unreadCount   Int      @default(0)
  
  // Metadata
  lastMessageAt DateTime @default(now())
  tags          String[] // For filtering/categorization
  notes         String?  // Agent notes
  labels        String[] @default([]) // Custom labels for organization
  priority      Priority @default(NORMAL)
  snoozedUntil  DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  messages      Message[]
  
  @@unique([tenantId, contactPhone])
  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([assignedAgentId])
  @@index([lastMessageAt])
  @@index([campaignId])
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  ARCHIVED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Message {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // WhatsApp identifiers (for idempotency)
  waMessageId   String?  @unique // Meta's message ID
  clientMessageId String? // Our outbound message ID
  
  // Message details
  direction     MessageDirection
  status        MessageStatus @default(PENDING)
  
  from          String   // Phone number
  to            String   // Phone number
  
  // Content
  type          MessageType @default(TEXT)
  text          String?
  
  // Media
  mediaType     String?  // image, video, audio, document
  mediaId       String?  // Meta media ID
  mediaMimeType String?
  mediaUrl      String?  // Downloaded/stored URL
  mediaFilename String?
  mediaCaption  String?
  
  // Template messages
  templateName  String?
  templateParams Json?   // Array of parameter values
  
  // Timestamps
  timestamp     DateTime @default(now())
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  errorMessage  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([conversationId])
  @@index([waMessageId])
  @@index([clientMessageId])
  @@index([status])
  @@index([timestamp])
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING   // Queued to send
  SENT      // Sent to Meta API
  DELIVERED // Meta confirmed delivery
  READ      // User read it
  FAILED    // Send/delivery failed
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  TEMPLATE
  INTERACTIVE
  LOCATION
  CONTACT
}

// ============================================
// CONTACTS
// ============================================

model Contact {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  phoneNumber  String   // WhatsApp phone number
  name         String?
  email        String?
  company      String?
  notes        String?  @db.Text
  tags         String[] @default([])
  
  // Campaign relation
  campaignId   String?
  campaign     Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  // Relations
  conversations Conversation[] @relation("ContactConversations")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, phoneNumber])
  @@index([tenantId])
  @@index([phoneNumber])
  @@index([campaignId])
}

// ============================================
// MESSAGE TEMPLATES
// ============================================

model Template {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Template details from Meta
  name      String   // Template name used in Meta (snake_case)
  displayName String? // Human-readable name shown in UI
  language  String   // e.g., en_US
  category  String   // MARKETING, UTILITY, AUTHENTICATION
  
  status    TemplateStatus @default(PENDING)
  
  // Template content
  headerType    String?  // TEXT, IMAGE, VIDEO, DOCUMENT
  headerText    String?
  headerMediaUrl String?
  
  bodyText      String   // Template body with {{1}} placeholders
  footerText    String?
  
  buttons       Json?    // Array of button configs
  components    Json?    // Raw Meta components payload
  
  // Metadata
  metaTemplateId String? // Meta's template ID
  rejectionReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, name, language])
  @@index([tenantId])
  @@index([status])
  @@index([metaTemplateId])
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
  DISABLED
}

// ============================================
// CAMPAIGNS
// ============================================

model Campaign {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  description String?  @db.Text
  
  // Campaign settings
  status      CampaignStatus @default(DRAFT)
  
  // Message configuration
  messageType MessageType @default(TEMPLATE)
  templateId  String?     // Reference to Template if using template
  messageText String?     @db.Text // For text messages
  mediaUrl    String?     // For media messages
  
  // Interactive message components (buttons, lists, etc.)
  interactiveType String?  // button, list, product, product_list
  interactiveData Json?    // Stores button/list configurations
  
  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  
  // Statistics
  totalContacts     Int @default(0)
  messagesSent      Int @default(0)
  messagesDelivered Int @default(0)
  messagesFailed    Int @default(0)
  messagesRead      Int @default(0)
  
  // Relations
  contacts      Contact[]
  conversations Conversation[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@index([status])
  @@index([scheduledAt])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  PAUSED
  CANCELLED
}

// ============================================
// CANNED RESPONSES (Quick Replies)
// ============================================

model CannedResponse {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title     String
  content   String   @db.Text
  shortcut  String   // e.g., "/welcome", "/thanks"
  category  String?
  isPublic  Boolean  @default(true) // Available to all agents
  
  createdById String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([tenantId])
  @@index([shortcut])
}

// ============================================
// USAGE & ANALYTICS (for billing & dashboards)
// ============================================

model DailyUsage {
  id        String   @id @default(cuid())
  tenantId  String
  date      DateTime @db.Date
  
  messagesSent      Int @default(0)
  messagesReceived  Int @default(0)
  messagesDelivered Int @default(0)
  messagesFailed    Int @default(0)
  
  conversationsStarted Int @default(0)
  conversationsResolved Int @default(0)
  
  createdAt DateTime @default(now())
  
  @@unique([tenantId, date])
  @@index([tenantId, date])
}

// ============================================
// SESSION MANAGEMENT
// ============================================

model Session {
  id        String   @id @default(cuid())
  token     String   @unique // The JWT token string
  
  // Relations (Optional to support both AdminUser and Agent)
  adminUserId String?
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  
  agentId     String?
  agent       Agent?     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Session details
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  
  @@index([adminUserId])
  @@index([agentId])
  @@index([token])
}

// ============================================
// FLOW BUILDER
// ============================================

model Flow {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  
  // Trigger configuration
  triggerType FlowTriggerType @default(KEYWORD)
  trigger     String?         // Keyword or other trigger data
  
  // Flow structure (React Flow format)
  nodes       Json     // Array of nodes
  edges       Json     // Array of edges
  
  isActive    Boolean  @default(false)
  
  // Analytics
  runsCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  executions  FlowExecution[]

  @@index([tenantId])
  @@index([isActive])
  @@index([triggerType])
}

enum FlowTriggerType {
  KEYWORD
  NEW_MESSAGE
  CONVERSATION_OPENED
  MANUAL
  BUTTON_CLICK
}

// ============================================
// FLOW EXECUTION (Outbox Pattern)
// ============================================

model FlowExecution {
  id          String   @id @default(cuid())
  
  // Flow reference
  flowId      String
  flow        Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  tenantId    String
  
  // Execution context
  contactPhone    String
  contactId       String?
  conversationId  String?
  messageBody     String?
  messageType     String?
  
  // Trigger information
  triggeredBy     FlowTriggerType
  triggerData     Json?  // Additional trigger context
  
  // Execution state
  status          FlowExecutionStatus @default(PENDING)
  currentNodeId   String?
  executionState  Json?  // Variables, button clicks, etc.
  
  // Timing
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Error handling
  error           String?
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([flowId])
  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])  // For polling pending executions
}

enum FlowExecutionStatus {
  PENDING      // Waiting to be picked up
  PROCESSING   // Currently executing
  COMPLETED    // Successfully completed
  FAILED       // Failed after retries
  CANCELLED    // Manually cancelled
}
